#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 2025/8/18 15:59
# @Author  : jc Han
# @help    :
import torch
import numpy as np
import smplx
from smplx import SMPLX
import trimesh

# 输入参数（直接复制你的JSON数据）
params = {
    "betas": [0.31648606061935425, -0.7585206627845764, -0.22112922370433807, 0.37603136897087097, 0.208547443151474, 0.3233436942100525, 0.08531229197978973, 0.21393389999866486, 0.02374798059463501, 0.08130274713039398],
    "root_pose": [3.0524868965148926, -0.008559639565646648, -0.01642513833940029],
    "body_pose": [[0.05712059140205383, 0.00578070105984807, 0.04749569296836853],
                  [0.051239605993032455, -0.032330337911844254, -0.08605112880468369],
                  [0.1413610279560089, 0.014346695505082607, 0.001708121271803975],
                  [0.09674135744571686, -0.08148984611034393, -0.058675918728113174], [0.22699442505836487, 0.06219553202390671, 0.07458065450191498], [-0.03178796172142029, -0.006465509999543428, 0.00765678146854043], [0.040122974663972855, 0.10445871204137802, -0.0843401849269867], [-0.007904677651822567, -0.03413393348455429, 0.07177148014307022], [-0.025034457445144653, 0.016769135370850563, 0.0031426071655005217], [0.009473225101828575, 0.0008100799168460071, 0.02414846234023571], [-0.0005189517978578806, -0.00020310626132413745, 0.014078824780881405], [0.04772895202040672, -0.024941042065620422, 0.0030497501138597727], [0.013466741889715195, 0.1360180526971817, -0.27857598662376404], [0.008643182925879955, -0.056916847825050354, 0.2470422238111496], [-0.06105323135852814, -0.013502872548997402, 0.027711519971489906], [0.12747153639793396, -0.09548522531986237, -0.87516188621521], [0.17024676501750946, 0.16970442235469818, 0.9198927879333496], [0.10207527130842209, -0.3309476375579834, -0.005307997576892376], [0.16833747923374176, 0.24883009493350983, 0.030651040375232697], [-0.06198827177286148, -0.01649477705359459, 0.11943268775939941], [-0.052664853632450104, 0.0016437015729025006, -0.016576986759901047]],
    "jaw_pose": [-0.018226860091090202, 3.4948927350342274e-05, 0.006060777232050896],
    "leye_pose": [0.0, 0.0, 0.0],
    "reye_pose": [0.0, 0.0, 0.0],
    "lhand_pose": [[0.05247792601585388, 0.16984161734580994, -0.24483762681484222], [0.0750255137681961, -0.07024336606264114, -0.2960183024406433], [-0.053703200072050095, -0.08174730092287064, -0.06098373979330063], [-0.1045452281832695, 0.07083335518836975, -0.4641364514827728], [-0.06607845425605774, 0.057452015578746796, -0.1756550520658493], [0.00185223831795156, -0.1022467166185379, -0.1507243812084198], [-0.41669991612434387, -0.35018202662467957, -0.3084845542907715], [0.11096108704805374, 0.0859331488609314, -0.18097467720508575], [-0.18202358484268188, 0.025596747174859047, 0.09003914147615433], [-0.05734413489699364, -0.08853146433830261, -0.41263437271118164], [-0.19974161684513092, 0.020319826900959015, -0.1114080622792244], [-0.14666597545146942, -0.10781580954790115, -0.1406654566526413], [0.7074387073516846, 0.41378843784332275, 0.00013268565817270428], [-0.5722739100456238, 0.00392390601336956, -0.05414697527885437], [0.5285096764564514, 0.01183114293962717, -0.14791476726531982]],
    "rhand_pose": [[0.03296831622719765, -0.1643201857805252, 0.3535405993461609], [0.13884475827217102, 0.06125273182988167, 0.39091619849205017], [-0.07994390279054642, 0.10149745643138885, 0.07525721192359924], [-0.16329187154769897, -0.05330321192741394, 0.5538356304168701], [-0.07108750939369202, -0.04308506101369858, 0.23446765542030334], [0.005100591573864222, 0.12492521852254868, 0.1808152198791504], [-0.4759383499622345, 0.4146404564380646, 0.4106689393520355], [0.12933164834976196, -0.08451364189386368, 0.1838788092136383], [-0.26295551657676697, -0.024020493030548096, -0.11032843589782715], [-0.11365090310573578, 0.13516807556152344, 0.5423702597618103], [-0.222663015127182, 0.01860065385699272, 0.168168842792511], [-0.17020012438297272, 0.11477147042751312, 0.18271180987358093], [0.7470327019691467, -0.3610958755016327, 0.002586678136140108], [-0.5755387544631958, -0.0019375905394554138, 0.0784284695982933], [0.6011055707931519, -0.033699750900268555, 0.12615986168384552]],
    "trans": [-0.006426866166293621, 0.35021913051605225, 2.6131527423858643]
}

# 转换为PyTorch张量
def to_tensor(data):
    if isinstance(data, list):
        return torch.tensor(data, dtype=torch.float32)
    elif isinstance(data, dict):
        return {k: to_tensor(v) for k, v in data.items()}
    return data

params = to_tensor(params)

# 初始化SMPLX模型
smplx_model = SMPLX(
    model_path="/mnt/cvda/cvda_phava/code/Han/PhyAvatar/utils/smplx_model",  # 替换为你的SMPLX模型路径
    gender="neutral",
    num_betas=10,
    use_pca=False,
    flat_hand_mean=False
)

# 生成网格
output = smplx_model(
    betas=params["betas"].unsqueeze(0),
    global_orient=params["root_pose"].unsqueeze(0),
    body_pose=params["body_pose"].unsqueeze(0),
    left_hand_pose=params["lhand_pose"].unsqueeze(0),
    right_hand_pose=params["rhand_pose"].unsqueeze(0),
    jaw_pose=params["jaw_pose"].unsqueeze(0),
    leye_pose=params["leye_pose"].unsqueeze(0),
    reye_pose=params["reye_pose"].unsqueeze(0),
    transl=params["trans"].unsqueeze(0),
    return_verts=True
)

# 导出PLY文件
vertices = output.vertices.detach().cpu().numpy().squeeze()
faces = smplx_model.faces

mesh = trimesh.Trimesh(vertices=vertices, faces=faces)
mesh.export("/mnt/cvda/cvda_phava/code/Han/PhyAvatar/utils/smplx_model/smplx_output.ply")

print("PLY文件已保存为 smplx_output.ply")