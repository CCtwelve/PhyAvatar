colmap feature_extractor --database_path ./colmap_0_17/database.db --image_path ./data/multipleview/0_17  --ImageReader.single_camera 0  --ImageReader.camera_model PINHOLE  --SiftExtraction.peak_threshold 0.001 --SiftExtraction.edge_threshold 80   --SiftExtraction.domain_size_pooling  1 --SiftExtraction.estimate_affine_shape 1

colmap spatial_matcher --database_path ./colmap_tmp_17/database.db --SiftMatching.max_num_matches 20000 --SpatialMatching.is_gps 0 --SpatialMatching.ignore_z 0  --SiftMatching.cross_check 1 --SiftMatching.guided_matching 1

# colmap exhaustive_matcher --database_path ./colmap_0_17/database.db --SiftMatching.guided_matching 1 --SiftMatching.cross_check 1

mkdir -p colmap_0_17/sparse/0

# --Mapper.ba_refine_principal_point 0 固定主点 （cx, cy）   --Mapper.ba_refine_focal_length 0   优化焦距

colmap mapper --database_path ./colmap_tmp_17/database.db --image_path ./data/multipleview/17   --output_path ./colmap_tmp_17/sparse  --Mapper.tri_ignore_two_view_tracks 0 --Mapper.ba_refine_focal_length 0  --Mapper.ba_refine_principal_point 0 --Mapper.ba_refine_extra_params 0

#  --Mapper.ba_refine_focal_length 0  --Mapper.ba_refine_principal_point 0 --Mapper.ba_refine_extra_params 0

colmap point_triangulator --database_path ./colmap_0_17/database.db --image_path ./data/multipleview/0_17 --input_path ./data/cam_txt_17 --output_path ./colmap_0_17/sparse/0 --Mapper.ba_global_max_num_iterations 200 --Mapper.ba_refine_focal_length 0   --Mapper.ba_refine_principal_point 0 --Mapper.tri_ignore_two_view_tracks 0    --Mapper.ba_refine_extra_params 0

    colmap point_filtering --input_path ./colmap_0_17/sparse/0 --output_path ./colmap_0_17/sparse/0    --min_track_len 2   --max_reproj_error 1  --min_tri_angle 1.5

    colmap model_converter --input_path ./colmap_tmp_17/sparse/0 --output_path ./colmap_tmp_17/sparse/0/3D.ply --output_type PLY

    colmap bundle_adjuster --input_path ./colmap_tmp_17/sparse/0 --output_path ./colmap_tmp_17/sparse/1 --BundleAdjustment.refine_focal_length 1 --BundleAdjustment.refine_extra_params 1

    mkdir -p ./colmap_tmp/sparse/TXT

    colmap model_converter --input_path ./colmap_tmp/sparse/0 --output_path ./colmap_tmp/sparse/TXT --output_type TXT

    cp ./colmap_tmp/sparse/TXT/cameras.txt  ./data/cam_txt_17/cameras_160.txt

    colmap model_converter --input_path ./colmap_tmp_17/sparse/0 --output_path ./colmap_tmp_17/sparse/0/bundled.ply --output_type PLY

colmap model_analyzer --path ./colmap_tmp_25/sparse/0

colmap image_undistorter --image_path ./data/multipleview/17 --input_path ./colmap_0_17/sparse/0 --output_path ./colmap_0_17/dense --output_type COLMAP

colmap patch_match_stereo --workspace_path ./colmap_tmp_17/dense  --PatchMatchStereo.geom_consistency 1

colmap stereo_fusion --workspace_path ./colmap_tmp_17/dense --output_path ./colmap_tmp_17/dense/fused.ply

colmap poisson_mesher --input_path /home/hljiang/disk8t/Project/3DGS/colmap/colmap_tmp_17/dense/fused.ply --output_path /home/hljiang/disk8t/Project/3DGS/colmap/colmap_tmp_17/dense/mesh_poisson.ply --PoissonMeshing.trim 6

	rm -rf ./colmap_0_17/sparse/* ./colmap_0_17/dense/*  ./colmap_0_17/database.db
cp  -r colmap_tmp_17/dense/images/ colmap_tmp_17

python Depth-Anything-V2/run.py --encoder vitl --pred-only --grayscale --img-path /home/hljiang/disk8t/Project/3DGS/colmap/data/multipleview/17 --outdir /home/hljiang/disk8t/Project/3DGS/colmap/data/multipleview/depth_17

python utils/make_depth_scale.py --base_dir /home/hljiang/disk8t/Project/3DGS/colmap/colmap_tmp_17 --depths_dir  /home/hljiang/disk8t/Project/3DGS/colmap/colmap_tmp_17/depth_17

python utils/make_depth_scale.py --base_dir /home/hljiang/disk8t/Project/3DGS/colmap/colmap_tmp_17 --depths_dir /home/hljiang/disk8t/Project/3DGS/colmap/data/multipleview/depth_17

DELETE FROM matches;

	sqlite3 ./colmap_tmp_17/database.db "DELETE FROM keypoints;DELETE FROM descriptors;DELETE FROM two_view_geometries;VACUUM;"

	sqlite3 ./colmap_tmp_17/database.db "SELECT * FROM images;"

	sqlite3 ./colmap_tmp_17/database.db "SELECT COUNT(*) FROM keypoints;"

	sqlite3 ./colmap_tmp_17/database.db "SELECT COUNT(*) FROM matches WHERE rows>=3"

	colmap automatic_reconstructor --image_path ./data/multipleview/17 --workspace_path ./colmap_tmp_17/sparse/1 --camera_model PINHOLE --quality HIGH

	colmap model_converter --input_path data/cam_txt_17 --output_path data/cam_txt_17 --output_type BIN

	--densify_grad_threshold 0.001  --densification_interval 50

